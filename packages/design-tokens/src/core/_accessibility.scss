// Accessibility-First SASS Functions
// WCAG 2.1 compliant color accessibility calculations
// Following W3C specifications for luminance and contrast ratios

@use 'sass:math';
@use 'sass:color';
@use 'sass:map';
@use '_color-palette' as palette;

// =============================================================================
// WCAG 2.1 LUMINANCE AND CONTRAST CALCULATIONS
// =============================================================================

/// Calculate the relative luminance of a color according to WCAG 2.1
/// Relative luminance is the relative brightness of any point in a colorspace,
/// normalized to 0 for darkest black and 1 for lightest white.
///
/// Formula: L = 0.2126 * R + 0.7152 * G + 0.0722 * B
/// where R, G and B are defined as:
/// - if RsRGB <= 0.03928 then R = RsRGB/12.92 else R = ((RsRGB+0.055)/1.055) ^ 2.4
///
/// @param {Color} $color - The color to calculate luminance for
/// @return {Number} Relative luminance value between 0 and 1
/// @example
///   $luminance: luminance(#ffffff); // Returns 1
///   $luminance: luminance(#000000); // Returns 0
@function luminance($color) {
  // Extract RGB values and convert to 0-1 scale
  $red: math.div(color.red($color), 255);
  $green: math.div(color.green($color), 255);
  $blue: math.div(color.blue($color), 255);

  // Apply gamma correction according to WCAG 2.1 formula
  $red: if(
    $red <= 0.03928,
    math.div($red, 12.92),
    math.pow(math.div($red + 0.055, 1.055), 2.4)
  );
  $green: if(
    $green <= 0.03928,
    math.div($green, 12.92),
    math.pow(math.div($green + 0.055, 1.055), 2.4)
  );
  $blue: if(
    $blue <= 0.03928,
    math.div($blue, 12.92),
    math.pow(math.div($blue + 0.055, 1.055), 2.4)
  );

  // Calculate relative luminance using WCAG coefficients
  @return 0.2126 * $red + 0.7152 * $green + 0.0722 * $blue;
}

/// Calculate the contrast ratio between two colors according to WCAG 2.1
/// Contrast ratio = (L1 + 0.05) / (L2 + 0.05)
/// where L1 is the relative luminance of the lighter color and
/// L2 is the relative luminance of the darker color
///
/// @param {Color} $color1 - First color
/// @param {Color} $color2 - Second color
/// @return {Number} Contrast ratio between 1 and 21
/// @example
///   $ratio: contrast-ratio(#ffffff, #000000); // Returns 21 (maximum contrast)
///   $ratio: contrast-ratio(#ffffff, #ffffff); // Returns 1 (no contrast)
@function contrast-ratio($color1, $color2) {
  $l1: luminance($color1);
  $l2: luminance($color2);

  // Ensure L1 is the lighter color (higher luminance)
  @if $l2 > $l1 {
    $temp: $l1;
    $l1: $l2;
    $l2: $temp;
  }

  @return math.div($l1 + 0.05, $l2 + 0.05);
}

// =============================================================================
// WCAG COMPLIANCE CHECKER FUNCTIONS
// =============================================================================

/// Check if contrast ratio meets WCAG AA standards (4.5:1 for normal text)
/// @param {Color} $foreground - Foreground color (typically text)
/// @param {Color} $background - Background color
/// @return {Boolean} True if contrast meets WCAG AA standards
/// @example
///   $compliant: is-wcag-aa-compliant(#000000, #ffffff); // Returns true
@function is-wcag-aa-compliant($foreground, $background) {
  @return contrast-ratio($foreground, $background) >= 4.5;
}

/// Check if contrast ratio meets WCAG AAA standards (7:1 for normal text)
/// @param {Color} $foreground - Foreground color (typically text)
/// @param {Color} $background - Background color
/// @return {Boolean} True if contrast meets WCAG AAA standards
/// @example
///   $compliant: is-wcag-aaa-compliant(#000000, #ffffff); // Returns true
@function is-wcag-aaa-compliant($foreground, $background) {
  @return contrast-ratio($foreground, $background) >= 7;
}

/// Check if contrast ratio meets WCAG AA standards for large text (3:1)
/// Large text is defined as 18pt+ regular or 14pt+ bold
/// @param {Color} $foreground - Foreground color
/// @param {Color} $background - Background color
/// @return {Boolean} True if contrast meets WCAG AA large text standards
/// @example
///   $compliant: is-wcag-aa-large-compliant(#666666, #ffffff); // Returns true
@function is-wcag-aa-large-compliant($foreground, $background) {
  @return contrast-ratio($foreground, $background) >= 3;
}

// =============================================================================
// AUTOMATIC ACCESSIBLE COLOR SELECTION
// =============================================================================

/// Automatically choose between white and black text for optimal contrast
/// @param {Color} $background - Background color to test against
/// @return {Color} Either #ffffff or #000000 depending on which provides better contrast
/// @example
///   color: auto-text-color(#3b82f6); // Returns #ffffff (white text on blue bg)
@function auto-text-color($background) {
  $white-contrast: contrast-ratio(#ffffff, $background);
  $black-contrast: contrast-ratio(#000000, $background);

  @return if($white-contrast > $black-contrast, #ffffff, #000000);
}

/// Find the most accessible text color from a list of options
/// @param {Color} $background - Background color to test against
/// @param {List} $text-colors - List of potential text colors to choose from
/// @return {Color} Color from the list with the highest contrast ratio
/// @example
///   $accessible: most-accessible-color(#3b82f6, (#ffffff, #000000, #666666));
@function most-accessible-color($background, $text-colors) {
  $best-color: null;
  $best-ratio: 0;

  @each $color in $text-colors {
    $ratio: contrast-ratio($color, $background);
    @if $ratio > $best-ratio {
      $best-ratio: $ratio;
      $best-color: $color;
    }
  }

  @return $best-color;
}

/// Get an accessible text color from our design system
/// Automatically selects from primary, secondary, tertiary text colors
/// @param {Color} $background - Background color
/// @param {String} $preference - Preferred text type ('light', 'dark', or 'auto')
/// @return {Color} Most accessible text color from our design system
/// @example
///   color: accessible-text($bg-color, 'auto');
@function accessible-text($background, $preference: 'auto') {
  $light-options: (
    palette.text('inverse'),
    // #ffffff
    palette.color('gray', 100),
    // Very light gray
    palette.color('gray', 200) // Light gray
  );

  $dark-options: (
    palette.text('primary'),
    // #171717
    palette.text('secondary'),
    // #404040
    palette.text('tertiary') // #737373
  );

  @if $preference == 'light' {
    @return most-accessible-color($background, $light-options);
  } @else if $preference == 'dark' {
    @return most-accessible-color($background, $dark-options);
  } @else {
    // Auto mode - test both light and dark options
    $best-light: most-accessible-color($background, $light-options);
    $best-dark: most-accessible-color($background, $dark-options);

    $light-ratio: contrast-ratio($best-light, $background);
    $dark-ratio: contrast-ratio($best-dark, $background);

    @return if($light-ratio > $dark-ratio, $best-light, $best-dark);
  }
}

// =============================================================================
// COLOR ADJUSTMENT FUNCTIONS FOR ACCESSIBILITY
// =============================================================================

/// Adjust a color to meet minimum contrast ratio against a background
/// @param {Color} $color - Color to adjust
/// @param {Color} $background - Background color to test against
/// @param {Number} $min-ratio - Minimum acceptable contrast ratio (default: 4.5)
/// @param {String} $direction - 'lighter', 'darker', or 'auto'
/// @return {Color} Adjusted color that meets the contrast requirement
/// @example
///   $accessible-blue: ensure-contrast(#3b82f6, #ffffff, 4.5, 'darker');
@function ensure-contrast(
  $color,
  $background,
  $min-ratio: 4.5,
  $direction: 'auto'
) {
  $current-ratio: contrast-ratio($color, $background);

  // Already meets requirement
  @if $current-ratio >= $min-ratio {
    @return $color;
  }

  // Determine adjustment direction if auto
  @if $direction == 'auto' {
    $bg-luminance: luminance($background);
    $direction: if($bg-luminance > 0.5, 'darker', 'lighter');
  }

  $adjusted-color: $color;
  $step: 0.05; // Adjustment step
  $max-iterations: 100; // Prevent infinite loops
  $iterations: 0;

  @while contrast-ratio($adjusted-color, $background) <
    $min-ratio and
    $iterations <
    $max-iterations
  {
    @if $direction == 'darker' {
      $adjusted-color: color.adjust($adjusted-color, $lightness: -$step * 100%);
    } @else {
      $adjusted-color: color.adjust($adjusted-color, $lightness: $step * 100%);
    }
    $iterations: $iterations + 1;
  }

  @return $adjusted-color;
}

/// Find the closest accessible shade from our color palette
/// @param {String} $family - Color family (e.g., 'blue', 'gray')
/// @param {Color} $background - Background color to test against
/// @param {Number} $min-ratio - Minimum contrast ratio (default: 4.5)
/// @return {Color} Most accessible shade from the color family
/// @example
///   $accessible: accessible-shade('blue', #ffffff, 4.5); // Returns blue-600 or darker
@function accessible-shade($family, $background, $min-ratio: 4.5) {
  $shades: (50, 100, 200, 300, 400, 500, 600, 700, 800, 900);
  $best-shade: null;
  $best-ratio: 0;

  @each $shade in $shades {
    $color: palette.color($family, $shade);
    $ratio: contrast-ratio($color, $background);

    // Find the shade with the best contrast that meets minimum requirement
    @if $ratio >= $min-ratio and $ratio > $best-ratio {
      $best-ratio: $ratio;
      $best-shade: $shade;
    }
  }

  // If no shade meets requirement, return the darkest or lightest
  @if $best-shade == null {
    $bg-luminance: luminance($background);
    $best-shade: if($bg-luminance > 0.5, 900, 50);
  }

  @return palette.color($family, $best-shade);
}

// =============================================================================
// ACCESSIBILITY VALIDATION MIXINS
// =============================================================================

/// Validate and warn about accessibility issues in color combinations
/// @param {Color} $foreground - Foreground color
/// @param {Color} $background - Background color
/// @param {String} $context - Context description for better error messages
/// @example
///   @include validate-contrast(#666666, #ffffff, 'button text');
@mixin validate-contrast($foreground, $background, $context: 'element') {
  $ratio: contrast-ratio($foreground, $background);

  @if $ratio < 3 {
    @warn 'ACCESSIBILITY ERROR: #{$context} contrast ratio is #{$ratio} (WCAG fails all standards). Foreground: #{$foreground}, Background: #{$background}';
  } @else if $ratio < 4.5 {
    @warn 'ACCESSIBILITY WARNING: #{$context} contrast ratio is #{$ratio} (WCAG AA failed, large text only). Foreground: #{$foreground}, Background: #{$background}';
  } @else if $ratio < 7 {
    @warn 'ACCESSIBILITY INFO: #{$context} contrast ratio is #{$ratio} (WCAG AA passed, AAA failed). Foreground: #{$foreground}, Background: #{$background}';
  }
}

/// Apply colors with automatic accessibility validation
/// @param {Color} $foreground - Foreground color
/// @param {Color} $background - Background color
/// @param {String} $context - Context for warnings
/// @example
///   @include accessible-colors(#333333, #ffffff, 'card text');
@mixin accessible-colors($foreground, $background, $context: 'element') {
  @include validate-contrast($foreground, $background, $context);

  color: $foreground;
  background-color: $background;
}

// =============================================================================
// HELPER FUNCTIONS FOR COMMON PATTERNS
// =============================================================================

/// Get contrast-safe color combination for our semantic colors
/// @param {String} $semantic - Semantic color name ('primary', 'success', etc.)
/// @param {String} $variant - 'light', 'medium', 'dark' for different background variants
/// @return {Map} Map with 'background' and 'text' keys
/// @example
///   $colors: semantic-contrast('primary', 'medium');
///   background-color: map.get($colors, 'background');
///   color: map.get($colors, 'text');
@function semantic-contrast($semantic, $variant: 'medium') {
  $bg-color: null;

  // Select background variant
  @if $variant == 'light' {
    $bg-color: palette.semantic('#{$semantic}-light');
  } @else if $variant == 'dark' {
    $bg-color: palette.semantic('#{$semantic}-dark');
  } @else {
    $bg-color: palette.semantic($semantic);
  }

  // Get accessible text color
  $text-color: accessible-text($bg-color);

  @return (
    'background': $bg-color,
    'text': $text-color,
    'contrast-ratio': contrast-ratio($text-color, $bg-color)
  );
}

/// Create a complete accessible color scheme for a component state
/// @param {String} $state - Component state ('default', 'hover', 'focus', 'active', 'disabled')
/// @param {String} $semantic - Base semantic color
/// @return {Map} Complete color scheme with all necessary colors
/// @example
///   $scheme: component-color-scheme('hover', 'primary');
@function component-color-scheme($state, $semantic: 'primary') {
  $base-bg: palette.semantic($semantic);
  $scheme: ();

  @if $state == 'default' {
    $scheme: semantic-contrast($semantic, 'medium');
  } @else if $state == 'hover' {
    $hover-bg: palette.semantic('#{$semantic}-dark');
    $scheme: (
      'background': $hover-bg,
      'text': accessible-text($hover-bg),
      'contrast-ratio': contrast-ratio(accessible-text($hover-bg), $hover-bg),
    );
  } @else if $state == 'focus' {
    $scheme: semantic-contrast($semantic, 'dark');
    $scheme: map.merge(
      $scheme,
      (
        'outline': palette.semantic($semantic),
      )
    );
  } @else if $state == 'active' {
    $active-bg: ensure-contrast(
      $base-bg,
      palette.surface('background'),
      4.5,
      'darker'
    );
    $scheme: (
      'background': $active-bg,
      'text': accessible-text($active-bg),
      'contrast-ratio': contrast-ratio(accessible-text($active-bg), $active-bg),
    );
  } @else if $state == 'disabled' {
    $disabled-bg: palette.color('gray', 100);
    $scheme: (
      'background': $disabled-bg,
      'text': palette.text('disabled'),
      'contrast-ratio': contrast-ratio(palette.text('disabled'), $disabled-bg),
    );
  }

  @return $scheme;
}
